#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#define TABULEIRO 4

void incializar(int matriz[][TABULEIRO]);
void mostrar(int matriz[][TABULEIRO]);
void inserir_num(int matriz[][TABULEIRO], int aleatorio);
int contar_vazios(int matriz[][TABULEIRO]);
int aleatorio(int vazios);
void mover_esquerda (int matriz[][TABULEIRO]); //funciona
void mover_direita (int matriz[][TABULEIRO]);  //consertar
void mover_cima (int matriz[][TABULEIRO]);     //consertar
void mover_baixo (int matriz[][TABULEIRO]);    //consertar

int main(void){
    system("clear");
    int matriz[TABULEIRO][TABULEIRO], jogo = 0; 
    unsigned short vazios = 0, n, i;
    char jogada = ' ';
    srand(time(NULL));

    
    printf("Deseja jogar?\n1 - sim\n2 - não\n");
    scanf("%d",&jogo);
    while(jogo > 2 || jogo < 1){
        printf("Digite apenas 1 ou 2\n");
        printf("Deseja jogar?\n1 - sim\n2 - não\n");
        scanf("%d",&jogo);
    }
    incializar(matriz);
    getchar();
    
    while(jogo == 1){
        vazios = contar_vazios(matriz);
        if(vazios > 2){
            n = (rand()%2)+1;
            for(i = 0; i < n; i++){
                inserir_num(matriz, aleatorio(vazios));
            }
        }else if(vazios == 1 || vazios == 2){
            inserir_num(matriz, aleatorio(vazios));
        }
        vazios = contar_vazios(matriz);
        mostrar(matriz);
        if(vazios == 0){
            printf("Você perdeu\n");
            return 1;
        }
        scanf("%c", &jogada);
        getchar();
        while(jogada != 'w' && jogada != 'W' && jogada != 's' && jogada != 'S' && jogada != 'd' && jogada != 'D' && jogada != 'a' && jogada != 'A'){
            printf("Apenas w a s d\n");
            scanf("%c", &jogada);
            getchar();
        }
        switch(jogada){
            case 'W':
            case 'w':
		mover_cima (matriz);           
            	break;
            case 'A':
            case 'a':
		mover_esquerda (matriz);
            	break;
            case 'S':
            case 's':
		mover_baixo (matriz);             
            	break;
            case 'D':
            case 'd':
		mover_direita (matriz);     
            	break;
            default:
            	break;
        }
        
    }
    
    
    return 0;
}

void incializar(int matriz[][TABULEIRO]){
    for(int l = 0; l < TABULEIRO; l++){
        for(int c = 0; c < TABULEIRO; c++){
            matriz[l][c] = 0;
        }
    }
}

void mostrar(int matriz[][TABULEIRO]){
    system("clear");
    for(int l = 0; l < TABULEIRO; l++){
        for(int c = 0; c < TABULEIRO; c++){
            printf("%d ",matriz[l][c]);
        }
        printf("\n");
    }
}

int contar_vazios(int matriz[][TABULEIRO]){
    int vazios = 0;
    for(int l = 0; l < TABULEIRO; l++){
        for(int c = 0; c < TABULEIRO; c++){
            if(matriz[l][c] == 0) vazios ++; 
        } 
    }
    return vazios;   
}
void inserir_num(int matriz[][TABULEIRO], int aleatorio){
    for(int l = 0; l < TABULEIRO; l++){
        for(int c = 0; c < TABULEIRO; c++){
            
            if(matriz[l][c] == 0){
                if(aleatorio == 0){
                    matriz[l][c] = 2;
                    return ;
                }else{
                    aleatorio--;
                }
            } 
        }
    }
}

int aleatorio(int vazios){    
    return rand()%vazios;
}

void mover_esquerda (int matriz[][TABULEIRO]) {
    for(int l = 0; l < TABULEIRO; l++){
    	for(int c = 0; c < TABULEIRO; c++){ //checando cada coluna de cada linha
			if(matriz[l][c] != 0){
				int t_pos = c-1, num_pos = c, valor = matriz[l][c]; //variaveis temporarias para checagem da posição/valor do numero
				while(t_pos >= 0){                                  //movimentar da posição anterior até a inicial na linha
					if(matriz[l][t_pos] == 0){
						matriz[l][t_pos] = matriz[l][num_pos];      //checa se é zero e substitui
						matriz[l][num_pos] = 0;
						num_pos--;
					} else if(matriz[l][t_pos] == valor) {
						matriz[l][t_pos] += matriz[l][num_pos];
						matriz[l][num_pos] = 0;                     //checa se é igual e soma
						num_pos = t_pos;
					}
					t_pos--;
				}
			}
		}
	}
}
void mover_direita (int matriz[][TABULEIRO]) {
	for(int l = 0; l < TABULEIRO; l++){
		for(int c = 0; c < TABULEIRO; c++){ 
			if(matriz[l][c] != 0){
				int t_pos = c+1, num_pos = c, valor = matriz[l][c]; 
				while(t_pos <= TABULEIRO-1){                                 
					if(matriz[l][t_pos] == 0){
						matriz[l][t_pos] = matriz[l][num_pos];      
						matriz[l][num_pos] = 0;
						num_pos++;
					} else if(matriz[l][t_pos] == valor) {
						matriz[l][t_pos] += matriz[l][num_pos];
						matriz[l][num_pos] = 0;                     
						num_pos = t_pos;
					}
					t_pos++;
				}
			}
		}
	}  
}
void mover_cima (int matriz[][TABULEIRO]) {
    for(int c = 0; c < TABULEIRO; c++){
    	for(int l = 0; l < TABULEIRO; l++){
			if(matriz[l][c] != 0){
				int t_pos = l-1, num_pos = l, valor = matriz[l][c]; 
				while(t_pos >= 0){                                  
					if(matriz[t_pos][c] == 0){
						matriz[t_pos][c] = matriz[num_pos][c];      
						matriz[num_pos][c] = 0;
						num_pos--;
					} else if(matriz[t_pos][c] == valor) {
						matriz[t_pos][c] += matriz[num_pos][c];
						matriz[num_pos][c] = 0;                     
						num_pos = t_pos;
					}
					t_pos--;
				}
			}
		}
	} 
}
void mover_baixo (int matriz[][TABULEIRO]) {
    for(int c = 0; c < TABULEIRO-1; c++){
    	for(int l = 0; l < TABULEIRO; l++){
			if(matriz[l][c] != 0){
				int t_pos = l+1, num_pos = l, valor = matriz[l][c]; 
				while(t_pos <= TABULEIRO){                                  
					if(matriz[t_pos][c] == 0){
						matriz[t_pos][c] = matriz[num_pos][c];      
						matriz[num_pos][c] = 0;
						num_pos++;
					} else if(matriz[t_pos][c] == valor) {
						matriz[t_pos][c] += matriz[num_pos][c];
						matriz[num_pos][c] = 0;                     
						num_pos = t_pos;
					}
					t_pos++;
				}
			}
		}
	}               
}
